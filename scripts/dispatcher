#!/system/bin/sh

# Flux Event Dispatcher
# Central event handler for inotifyd events


# Environment Setup

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
. "$SCRIPT_DIR/log"
. "$SCRIPT_DIR/const"
[ -f "$CACHE_CONFIG_FILE" ] && { set -a; . "$CACHE_CONFIG_FILE"; set +a; }
[ -f "$KERNEL_CACHE_FILE" ] && { set -a; . "$KERNEL_CACHE_FILE"; set +a; }

export LOG_COMPONENT="Disp"

# Helper Functions

start_components() {
    [ -f "$MAGISK_MOD_DIR/disable" ] && { log_warn "Service disabled, ignoring start trigger"; return; }
    log_info "Starting components..."
    sh "$CORE_SCRIPT" start &
    sh "$TPROXY_SCRIPT" start &
}

check_all_ready() {
    [ -f "$MAGISK_MOD_DIR/disable" ] && { log_warn "Service disabled, ignoring readiness trigger"; return; }
    [ -f "$EVENTS_DIR/core_ok" ] && [ -f "$EVENTS_DIR/tproxy_ok" ] && {
        rm -f "$EVENTS_DIR/core_ok" "$EVENTS_DIR/tproxy_ok"
        log_info "All components ready, starting ipmonitor..."
        nohup sh "$IP_MONITOR_SCRIPT" start >/dev/null 2>&1 &
        sync_prop
        log_info "Flux Service is now READY"
    }
}

stop_components() {
    log_info "Stopping services..."
    sh "$CORE_SCRIPT" stop &
    sh "$TPROXY_SCRIPT" stop &
    sh "$IP_MONITOR_SCRIPT" stop &
    wait
    rm -f "$EVENTS_DIR/core_ok" "$EVENTS_DIR/tproxy_ok" 2>/dev/null
    sync_prop
    prop_clear
    log_info "Service stopped"
}

rollback_components() {
    log_warn "Rolling back..."
    sh "$CORE_SCRIPT" stop 2>/dev/null &
    sh "$TPROXY_SCRIPT" stop 2>/dev/null &
    sh "$IP_MONITOR_SCRIPT" stop 2>/dev/null &
    wait
    sync_prop
}

# Event Dispatch Logic

main() {
    # inotifyd argument handling:
    # - Directory monitoring: handler EVENT DIR FILENAME (3 args)
    # - File monitoring: handler EVENT FILEPATH (2 args)
    local event_type="$1"
    local watched_path
    local event_name
    
    if [ -n "$3" ]; then
        # Directory monitoring mode
        local watched_dir="$2"
        event_name="$3"
        watched_path="$watched_dir/$event_name"
    else
        # File monitoring mode
        watched_path="$2"
        event_name=$(basename "$watched_path")
    fi
    
    log_debug "Event: $event_name ($event_type)"
    
    case "$event_name" in
        # === Magisk module toggle ===
        disable)
            case "$event_type" in
                d) sh "$INIT_SCRIPT" init & ;;   # Delete = Enable = Start
                n) stop_components ;;      # Create = Disable = Stop
            esac
            ;;
        # === Flow markers ===
        init_ok)
            rm -f "$watched_path" 2>/dev/null
            start_components
            ;;
        core_ok|tproxy_ok)
            check_all_ready
            ;;
        # === Failure handling ===
        fail)
            rollback_components
            exit 0
            ;;
        # === IP sync ===
        ip_sync)
            rm -f "$watched_path" 2>/dev/null
            sh "$IP_HANDLER_SCRIPT" sync &
            ;;
        # === Unknown/Cleanup ===
        *)
            rm -f "$watched_path" 2>/dev/null
            ;;
    esac
}

main "$@"
