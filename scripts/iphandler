#!/system/bin/sh

# Flux IP Handler
# Synchronizes local addresses with iptables chains


# Environment Setup

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
. "$SCRIPT_DIR/const"
. "$SCRIPT_DIR/log"

export LOG_COMPONENT="Sync"

# Helper Functions

# Generic wrapper for iptables/ip6tables with wait lock
_run_ipt_command() {
    local cmd="$1"; shift
    command "$cmd" -w 100 "$@"
}

iptables()  { _run_ipt_command iptables "$@"; }
ip6tables() { _run_ipt_command ip6tables "$@"; }

_ipt_cmd() {
    local proto="$1"; shift
    [ "$proto" = "6" ] && ip6tables "$@" || iptables "$@"
}

# IP Sync Logic

sync_all_addresses() {
    # --- IPv4 Sync ---
    local sync_awk='
        BEGIN { count=0 }
        /inet / {
            split($2, parts, "/")
            ip = parts[1]
            if (ip !~ /^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$/) next
            if (ip ~ /^127\./ || ip ~ /^0\./) next
            ips[count++] = ip
        }
        END {
            tables_count = split(targets, t, " ")
            for (j=1; j<=tables_count; j++) {
                if (t[j] == "") continue
                print "*" t[j]
                print ":LOCAL_IP - [0:0]"
                for (i=0; i<count; i++) {
                    print "-A LOCAL_IP -d " ips[i] " -p udp ! --dport 53 -j ACCEPT"
                    print "-A LOCAL_IP -d " ips[i] " ! -p udp -j ACCEPT"
                }
                print "COMMIT"
            }
        }'

    local sync_awk_v6='
        BEGIN { count=0 }
        /inet6 / {
            split($2, parts, "/")
            ip = parts[1]
            if (ip !~ /^[0-9a-fA-F:]+$/ || index(ip, ":") == 0) next
            if (ip ~ /^fe80:/ || ip ~ /^::1/) next
            ips[count++] = ip
        }
        END {
            tables_count = split(targets, t, " ")
            for (j=1; j<=tables_count; j++) {
                if (t[j] == "") continue
                print "*" t[j]
                print ":LOCAL_IP6 - [0:0]"
                for (i=0; i<count; i++) {
                    print "-A LOCAL_IP6 -d " ips[i] " -p udp ! --dport 53 -j ACCEPT"
                    print "-A LOCAL_IP6 -d " ips[i] " ! -p udp -j ACCEPT"
                }
                print "COMMIT"
            }
        }'

    # --- IPv4 Sync ---
    local v4_targets="$PRIMARY_TABLE"
    [ "$PRIMARY_TABLE" = "mangle" ] && v4_targets="mangle nat"
    
    if ! ip -4 addr show 2>/dev/null | awk -v targets="$v4_targets" "$sync_awk" | _run_ipt_command iptables-restore --noflush; then
        log_warn "IPv4 sync failed"
    fi
    
    # Hook chains
        _ipt_cmd 4 -t "$PRIMARY_TABLE" -C BYPASS_IP -j LOCAL_IP 2>/dev/null || \
        _ipt_cmd 4 -t "$PRIMARY_TABLE" -I BYPASS_IP -j LOCAL_IP

    if [ "$PRIMARY_TABLE" = "mangle" ]; then
         _ipt_cmd 4 -t nat -C PREROUTING -j LOCAL_IP 2>/dev/null || \
            _ipt_cmd 4 -t nat -I PREROUTING -j LOCAL_IP
    fi

    # --- IPv6 Sync ---
    if [ "$PROXY_IPV6" = "1" ]; then
        local v6_targets="$PRIMARY_TABLE"
        [ "$PRIMARY_TABLE" = "mangle" ] && [ "$KFEAT_IPV6_NAT" = "1" ] && v6_targets="mangle nat"
        
        if ! ip -6 addr show 2>/dev/null | awk -v targets="$v6_targets" "$sync_awk_v6" | _run_ipt_command ip6tables-restore --noflush; then
            log_warn "IPv6 sync failed"
        fi
        
        # Hook chains
        _ipt_cmd 6 -t "$PRIMARY_TABLE" -C BYPASS_IP6 -j LOCAL_IP6 2>/dev/null || \
            _ipt_cmd 6 -t "$PRIMARY_TABLE" -I BYPASS_IP6 -j LOCAL_IP6

        if [ "$KFEAT_IPV6_NAT" = "1" ]; then
             _ipt_cmd 6 -t nat -C PREROUTING -j LOCAL_IP6 2>/dev/null || \
                _ipt_cmd 6 -t nat -I PREROUTING -j LOCAL_IP6
        fi
    fi
    return 0
}

# Main

_init_runtime() {
    if [ "$PROXY_MODE" = "2" ]; then
        PRIMARY_TABLE="nat"
    else
        PRIMARY_TABLE="mangle"
    fi
    return 0
}

main() {
    _init_runtime

    local action="${1:-}"
    
    case "$action" in
        sync)
            if sync_all_addresses; then
                log_debug "Synced local IPs"
                return 0
            else
                log_error "Failed to sync local IPs"
                return 1
            fi
            ;;
        *)
            printf 'Usage: %s {sync}\n' "$0"
            exit 1
            ;;
    esac
}

main "$@"
