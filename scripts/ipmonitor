#!/system/bin/sh

# ==============================================================================
# Flux IP Monitor Daemon (ipmonitor)
# Description: Monitors IP changes and triggers ip_handler via dispatch events
# Note: Pure monitor, no iptables operations here.
# ==============================================================================

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
. "$SCRIPT_DIR/const"
. "$SCRIPT_DIR/log"
[ -f "$CACHE_CONFIG_FILE" ] && { set -a; . "$CACHE_CONFIG_FILE"; set +a; }

export LOG_COMPONENT="Monitor"

# ==============================================================================
# [ Main Loop ]
# ==============================================================================

    _cleanup() {
        pkill -P $$ 2>/dev/null
    }
    trap '_cleanup; exit 0' EXIT INT TERM
    
echo $$ > "$MONITOR_PID_FILE" && log_info "Starting IP Monitor (PID: $$, debounce=${DEBOUNCE_INTERVAL}s)"

touch "$EVENTS_DIR/ip_sync"

dirty=0

ip monitor address 2>/dev/null | while true; do
    if read -t "$DEBOUNCE_INTERVAL" -r line; then
        if [ -n "$line" ]; then
            dirty=1
        fi
    else
        if [ "$dirty" -eq 1 ]; then
            log_debug "IPs stabilized, triggering sync"
            touch "$EVENTS_DIR/ip_sync"
            dirty=0
        fi
    fi
done

