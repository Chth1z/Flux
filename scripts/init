#!/system/bin/sh

# ==============================================================================
# [ Flux Initialization Orchestrator ]
# Description: Pre-flight integrity checks, environment setup, and log rotation.
# ==============================================================================

# Strict error handling
set -eu
[ -n "${BASH_VERSION:-}" ] && set -o pipefail

readonly SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
. "${SCRIPT_DIR}/const"
. "${SCRIPT_DIR}/log"

readonly LOG_COMPONENT="Init"

# ==============================================================================
# [ Pre-flight Checks ]
# ==============================================================================

_check_integrity() {
    [ ! -f "${SING_BOX_BIN}" ] && { log_error "Sing-box binary missing: ${SING_BOX_BIN}"; return 1; }

    for script in "${CORE_SCRIPT}" "${TPROXY_SCRIPT}" "${IP_MONITOR_SCRIPT}" "${CACHE_SCRIPT}" \
                  "${UPDATE_SCRIPT}" "${DISPATCHER_SCRIPT}" "${RULES_SCRIPT}" "${CONFIG_SCRIPT}"
    do
        [ ! -f "${script}" ] && { log_error "Script missing: ${script##*/}"; return 1; }
    done

    for conf in "${SETTINGS_FILE}" "${CONFIG_FILE}"; do
        [ ! -f "${conf}" ] && { log_error "Config missing: ${conf##*/}"; return 1; }
    done
    return 0
}

_cleanup_failure() {
    [ ! -f "${EVENT_FAIL}" ] && return 0

    log_warn "Detected previous failure state, cleaning up..."
    # Simulate stop to cleanup any leftover processes/rules
    sh "${CORE_SCRIPT}" stop < /dev/null &
    sh "${TPROXY_SCRIPT}" stop < /dev/null &
    sh "${IP_MONITOR_SCRIPT}" stop < /dev/null &
    wait
    rm -f "${EVENT_FAIL}" "${EVENT_CORE_OK}" "${EVENT_TPROXY_OK}" 2>/dev/null
    return 0
}

# ==============================================================================
# [ Directory Initialization ]
# ==============================================================================

_init_dirs() {
    local dir
    for dir in "${RUN_DIR}" "${CACHE_DIR}" "${EVENTS_DIR}"; do
        [ ! -d "${dir}" ] && mkdir -p "${dir}"
    done
    [ -d "${RUN_DIR}" ] && chmod 0755 "${RUN_DIR}"
    return 0
}

# ==============================================================================
# [ Log Maintenance ]
# ==============================================================================

_rotate_log() {
    local log sz
    for log in "${FLUX_LOG}" "${SING_BOX_LOG}"; do
        [ ! -f "${log}" ] && continue
        sz=$(stat -c%s "${log}" 2>/dev/null || stat -f%z "${log}" 2>/dev/null || echo 0)
        if [ "${sz}" -gt "${LOG_MAX_SIZE}" ]; then
            log_info "Rotating ${log##*/} (size: ${sz})"
            cp -f "${log}" "${log}.bak" && : > "${log}"
        fi
    done
    return 0
}

# ==============================================================================
# [ Cache Validation ]
# ==============================================================================

_validate_cache() {
    # Cache validation: check meta marker, rebuild if missing
    if [ -f "${CACHE_META_FILE}" ]; then
        log_info "Cache is valid, skipping build"
    else
        log_info "Cache invalid or missing, rebuilding..."
        if ! sh "${CACHE_SCRIPT}" build; then
            log_error "Cache rebuild failed"
            touch "${EVENT_FAIL}"
            return 1
        fi
    fi
    return 0
}

# ==============================================================================
# [ Update Check ]
# ==============================================================================

_check_update() {
    if [ ! -f "${CONFIG_FILE}" ]; then
        sh "${UPDATE_SCRIPT}" update
    else
        local last; last=$(stat -c%Y "${CONFIG_FILE}" 2>/dev/null || stat -f%m "${CONFIG_FILE}" 2>/dev/null || echo 0)
        local now; now=$(date +%s)        
        if [ $((now - last)) -ge "${UPDATE_INTERVAL}" ]; then
            sh "${UPDATE_SCRIPT}" update
        else
            log_debug "Config up to date"
        fi
    fi
    return 0
}

# ==============================================================================
# [ Init Environment ]
# ==============================================================================

init_env() {
    _cleanup_failure
    _init_dirs || { touch "${EVENT_FAIL}"; return 1; }
    _check_integrity || { touch "${EVENT_FAIL}"; return 1; }
    _check_update || { touch "${EVENT_FAIL}"; return 1; }
    _validate_cache || { touch "${EVENT_FAIL}"; return 1; }
    _rotate_log 2>/dev/null
    touch "${EVENT_INIT_OK}"
    return 0
}

# ==============================================================================
# [ Startup Orchestration ]
# ==============================================================================

main() {
    local action="${1:-}"

    case "${action}" in
        init)
            init_env
            ;;
        *)
            echo "Usage: $0 {init}"
            exit 1
            ;;
    esac
}

main "$@"
