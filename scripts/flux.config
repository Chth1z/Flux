#!/system/bin/sh

# ==============================================================================
# Flux Configuration Module (flux.config)
# Description: Configuration loading and defaults
# ==============================================================================

# ==============================================================================
# [ Directory Structure ]
# ==============================================================================
# Structure
readonly FLUX_DIR="/data/adb/flux"
readonly BIN_DIR="$FLUX_DIR/bin"
readonly CONF_DIR="$FLUX_DIR/conf"
readonly SCRIPTS_DIR="$FLUX_DIR/scripts"
readonly RUN_DIR="$FLUX_DIR/run"
readonly TOOLS_DIR="$FLUX_DIR/tools"
readonly MAGISK_MOD_DIR="/data/adb/modules/flux"
# Core Files
readonly SING_BOX_BIN="$BIN_DIR/sing-box"
readonly CONFIG_FILE="$CONF_DIR/config.json"
readonly SETTINGS_FILE="$CONF_DIR/settings.ini"
readonly PID_FILE="$RUN_DIR/sing-box.pid"
readonly LOG_FILE="$RUN_DIR/flux.log"
# Scripts
readonly TPROXY_SCRIPT="$SCRIPTS_DIR/flux.tproxy"
readonly UPDATE_SCRIPT="$SCRIPTS_DIR/updater.sh"
readonly START_SCRIPT="$SCRIPTS_DIR/start.sh"
# Temporary Files
readonly TMP_SUB_CONVERTED="$RUN_DIR/sub_temp.json"
readonly TMP_NODES_EXTRACTED="$RUN_DIR/nodes.json"
readonly GENERATE_FILE="$TOOLS_DIR/generate.ini"
# Module Files
readonly PROP_FILE="$MAGISK_MOD_DIR/module.prop"
# Script-specific files
readonly TEMPLATE_FILE="$TOOLS_DIR/base/singbox.json"
readonly CONFIG_BACKUP="$CONF_DIR/config.json.bak"
# Cache Files
readonly IP_CACHE_FILE="$RUN_DIR/cache_ip"
readonly UID_CACHE_FILE="$RUN_DIR/cache_uid"
readonly KERNEL_CACHE_FILE="$RUN_DIR/cache_kernel"
# State Files
readonly LOCK_FILE="$FLUX_DIR/.flux.lock"
readonly STATE_FILE="$FLUX_DIR/.state"
readonly LOCK_TIMEOUT=30

# ==============================================================================
# [ State Constants ]
# ==============================================================================
readonly STATE_STOPPED="STOPPED"
readonly STATE_STARTING="STARTING"
readonly STATE_RUNNING="RUNNING"
readonly STATE_STOPPING="STOPPING"
readonly STATE_FAILED="FAILED"
readonly STATE_ROLLING_BACK="ROLLING_BACK"
# Component names
readonly COMP_CORE="core"
readonly COMP_TPROXY="tproxy"
# Terminal states for barrier wait
readonly TERMINAL_STATES="RUNNING FAILED STOPPED"


# ==============================================================================
# [ Exports & Env ]
# ==============================================================================
# Export for subprocesses
export PATH="$BIN_DIR:/data/adb/magisk:/data/adb/ksu/bin:$PATH"
export FLUX_DIR BIN_DIR CONF_DIR SCRIPTS_DIR RUN_DIR TOOLS_DIR
# Network Configuration
readonly USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"


# ==============================================================================
# [ Lightweight Log Config ]
# ==============================================================================
# Load only log-related settings for standalone scripts
# Use this instead of load_flux_config when only logging is needed
load_log_config() {
    [ -f "$SETTINGS_FILE" ] || return 0
    
    # Parse only log-related variables from settings
    local line
    while IFS= read -r line || [ -n "$line" ]; do
        case "$line" in
            LOG_LEVEL=*|LOG_MAX_SIZE=*) eval "$line" ;;
        esac
    done < "$SETTINGS_FILE"
    
    # Apply defaults if not set
    : "${LOG_LEVEL:=3}"
    : "${LOG_MAX_SIZE:=1048576}"
}


# ==============================================================================
# [ Config Loading - Data-Driven Approach ]
# ==============================================================================
# Apply defaults using for-loop to avoid subshell (pipe creates subshell)
_init_config_defaults() {
    local line key default current
    for line in \
        "SUBSCRIPTION_URL:" \
        "CORE_TIMEOUT:5" \
        "UPDATE_TIMEOUT:15" \
        "UPDATE_INTERVAL:86400" \
        "RETRY_COUNT:2" \
        "LOG_LEVEL:3" \
        "LOG_MAX_SIZE:1048576" \
        "CORE_USER:root" \
        "CORE_GROUP:root" \
        "ROUTING_MARK:" \
        "PROXY_TCP_PORT:1536" \
        "PROXY_UDP_PORT:1536" \
        "PROXY_MODE:0" \
        "DNS_HIJACK_ENABLE:1" \
        "DNS_PORT:1053" \
        "MOBILE_INTERFACE:rmnet_data+" \
        "WIFI_INTERFACE:wlan0" \
        "HOTSPOT_INTERFACE:wlan2" \
        "USB_INTERFACE:rndis+" \
        "PROXY_MOBILE:1" \
        "PROXY_WIFI:1" \
        "PROXY_HOTSPOT:0" \
        "PROXY_USB:0" \
        "PROXY_TCP:1" \
        "PROXY_UDP:1" \
        "PROXY_IPV6:0" \
        "MARK_VALUE:20" \
        "MARK_VALUE6:25" \
        "TABLE_ID:2025" \
        "APP_PROXY_ENABLE:0" \
        "APP_PROXY_MODE:1" \
        "PROXY_APPS_LIST:" \
        "BYPASS_APPS_LIST:" \
        "BYPASS_CN_IP:0" \
        "CN_IP_FILE:/data/adb/flux/conf/cnip.txt" \
        "CN_IPV6_FILE:/data/adb/flux/conf/cnip6.txt" \
        "CN_IP_URL:https://raw.githubusercontent.com/PaPerseller/chn-iplist/master/chn_ipv4.txt" \
        "CN_IPV6_URL:https://ispip.clang.cn/all_cn_ipv6.txt" \
        "MAC_FILTER_ENABLE:0" \
        "MAC_PROXY_MODE:1" \
        "PROXY_MACS_LIST:" \
        "BYPASS_MACS_LIST:" \
        "SKIP_CHECK_FEATURE:0" \
        "FAKEIP_RANGE_V4:198.18.0.0/15" \
        "FAKEIP_RANGE_V6:fc00::/18"
    do
        key="${line%%:*}"
        default="${line#*:}"
        eval "current=\"\$$key\""
        [ -z "$current" ] && eval "$key='$default'"
    done
}

load_flux_config() {
    # Source settings file if exists
    if [ -f "$SETTINGS_FILE" ]; then
        set -a
        . "$SETTINGS_FILE"
        set +a
    fi
    
    # Apply defaults for any unset variables (uses for-loop to avoid subshell)
    _init_config_defaults
    
    # Load values from config.json (ports, fakeip ranges)
    _load_config_json_values
}

# Export all config variables for child processes
# Call this in start.sh after load_flux_config so core/tproxy inherit via environment
export_flux_config() {
    export CORE_TIMEOUT UPDATE_TIMEOUT UPDATE_INTERVAL RETRY_COUNT \
           LOG_LEVEL LOG_MAX_SIZE CORE_USER CORE_GROUP ROUTING_MARK \
           PROXY_TCP_PORT PROXY_UDP_PORT PROXY_MODE \
           DNS_HIJACK_ENABLE DNS_PORT \
           MOBILE_INTERFACE WIFI_INTERFACE HOTSPOT_INTERFACE USB_INTERFACE \
           PROXY_MOBILE PROXY_WIFI PROXY_HOTSPOT PROXY_USB \
           PROXY_TCP PROXY_UDP PROXY_IPV6 \
           MARK_VALUE MARK_VALUE6 TABLE_ID \
           APP_PROXY_ENABLE APP_PROXY_MODE PROXY_APPS_LIST BYPASS_APPS_LIST \
           BYPASS_CN_IP CN_IP_FILE CN_IPV6_FILE CN_IP_URL CN_IPV6_URL \
           MAC_FILTER_ENABLE MAC_PROXY_MODE PROXY_MACS_LIST BYPASS_MACS_LIST \
           SKIP_CHECK_FEATURE FAKEIP_RANGE_V4 FAKEIP_RANGE_V6
}

# Internal: Load values from config.json
_load_config_json_values() {

    local jq_bin="$TOOLS_DIR/jq"
    [ ! -x "$jq_bin" ] || [ ! -f "$CONFIG_FILE" ] && return 1
    
    # Load proxy ports from inbound configuration
    local tproxy_port mixed_port
    tproxy_port=$("$jq_bin" -r '[.inbounds[] | select(.type=="tproxy")] | .[0].listen_port // empty' "$CONFIG_FILE" 2>/dev/null)
    if [ -n "$tproxy_port" ]; then
        PROXY_TCP_PORT="$tproxy_port"
        PROXY_UDP_PORT="$tproxy_port"
    else
        mixed_port=$("$jq_bin" -r '[.inbounds[] | select(.type=="mixed")] | .[0].listen_port // empty' "$CONFIG_FILE" 2>/dev/null)
        [ -n "$mixed_port" ] && PROXY_TCP_PORT="$mixed_port" && PROXY_UDP_PORT="$mixed_port"
    fi
    
    # Load FakeIP ranges (validate CIDR format before assigning)
    local v4 v6
    v4=$("$jq_bin" -r '.dns.servers[] | select(.type=="fakeip") | .inet4_range // empty' "$CONFIG_FILE" 2>/dev/null)
    v6=$("$jq_bin" -r '.dns.servers[] | select(.type=="fakeip") | .inet6_range // empty' "$CONFIG_FILE" 2>/dev/null)
    
    # Validate and assign v4 CIDR (format: x.x.x.x/n)
    case "$v4" in *"/"[0-9]*) FAKEIP_RANGE_V4="$v4" ;; esac
    # Validate and assign v6 CIDR (format: contains : and /n)
    case "$v6" in *":"*"/"[0-9]*) FAKEIP_RANGE_V6="$v6" ;; esac

    log_debug "TCP=$PROXY_TCP_PORT, UDP=$PROXY_UDP_PORT, FakeIP_v4=$FAKEIP_RANGE_V4, FakeIP_v6=$FAKEIP_RANGE_V6"
}
