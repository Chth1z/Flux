#!/system/bin/sh

# ==============================================================================
# Flux Initialization Script (init)
# Description: Initialize environment, run updater, build cache, trigger startup
# ==============================================================================

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
. "$SCRIPT_DIR/const"
. "$SCRIPT_DIR/log"
. "$SCRIPT_DIR/config"

export LOG_COMPONENT="Init"

# ==============================================================================
# [ Pre-flight Checks ]
# ==============================================================================

_check_integrity() {
    # Check binaries
    [ ! -f "$SING_BOX_BIN" ] && { log_error "Sing-box binary missing: $SING_BOX_BIN"; return 1; }
    
    # Check scripts
    for script in "$CORE_SCRIPT" "$TPROXY_SCRIPT" "$MONITOR_SCRIPT" "$CACHE_SCRIPT" "$UPDATE_SCRIPT"; do
        [ ! -f "$script" ] && { log_error "Script missing: $script"; return 1; }
    done
    
    # Check configs
    [ ! -f "$SETTINGS_FILE" ] && { log_error "Settings missing: $SETTINGS_FILE"; return 1; }
    [ ! -f "$CONFIG_FILE" ] && { log_error "Config missing: $CONFIG_FILE"; return 1; }
    
    return 0
}

_cleanup_failure() {
    [ ! -f "$EVENTS_DIR/fail" ] && return 0
    
    log_warn "Detected previous failure state, cleaning up..."
    # Simulate stop to cleanup any leftover processes/rules
    sh "$CORE_SCRIPT" stop >/dev/null 2>&1
    sh "$TPROXY_SCRIPT" stop >/dev/null 2>&1
    sh "$MONITOR_SCRIPT" stop >/dev/null 2>&1
    wait
    rm -f "$EVENTS_DIR/fail" "$EVENTS_DIR/core_ok" "$EVENTS_DIR/tproxy_ok" 2>/dev/null
    log_info "Cleanup completed"
}

# ==============================================================================
# [ Environment Setup ]
# ==============================================================================

_init_dirs() {
    for dir in "$RUN_DIR" "$CACHE_DIR" "$EVENTS_DIR"; do
        [ ! -d "$dir" ] && mkdir -p "$dir"
    done
    [ -d "$RUN_DIR" ] && chmod 0755 "$RUN_DIR"
}

# ==============================================================================
# [ Update Check (from orchestrator.on_update_check) ]
# ==============================================================================

_check_update() {
    log_debug "Checking for subscription updates"
    sh "$UPDATE_SCRIPT" check || log_debug "Update check completed"
}

# ==============================================================================
# [ Main Flow ]
# ==============================================================================

main() {
    log_info "Initializing service..."
    
    run "Check integrity" _check_integrity || { touch "$EVENTS_DIR/fail"; exit 1; }
    run "Setup directories" _init_dirs || { touch "$EVENTS_DIR/fail"; exit 1; }
    run "Cleanup failure" _cleanup_failure

    rotate_log 2>/dev/null
    
    _check_update
    
    run "Ensure Cache" sh "$CACHE_SCRIPT" || { touch "$EVENTS_DIR/fail"; exit 1; }

    log_debug "Init sequence completed"
    touch "$EVENTS_DIR/init_ok"
}

main
