#!/system/bin/sh

# ==============================================================================
# Flux Event Dispatcher (dispatcher)
# Description: Central event handler for inotifyd events
# ==============================================================================

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
. "$SCRIPT_DIR/log"
. "$SCRIPT_DIR/const"

export LOG_COMPONENT="Bus"
# inotifyd argument handling:
# - Directory monitoring: handler EVENT DIR FILENAME (3 args)
# - File monitoring: handler EVENT FILEPATH (2 args)
EVENT_TYPE="$1"
if [ -n "$3" ]; then
    # Directory monitoring mode
    WATCHED_DIR="$2"
    EVENT_NAME="$3"
    WATCHED_PATH="$WATCHED_DIR/$EVENT_NAME"
else
    # File monitoring mode
    WATCHED_PATH="$2"
    EVENT_NAME=$(basename "$WATCHED_PATH")
fi

log_debug "Event: $EVENT_NAME ($EVENT_TYPE)"

# ==============================================================================
# [ Helper Functions ]
# ==============================================================================

_start_components() {
    [ -f "$MAGISK_MOD_DIR/disable" ] && { log_warn "Service disabled, ignoring start trigger"; return; }
    log_info "Starting components..."
    sh "$CORE_SCRIPT" start &
    sh "$TPROXY_SCRIPT" start &
}

_kill_ipmonitor() {
    if [ -f "$MONITOR_PID_FILE" ]; then
        local mpid
        mpid=$(cat "$MONITOR_PID_FILE")
        if [ -n "$mpid" ]; then
            kill "$mpid" 2>/dev/null
        fi
        rm -f "$MONITOR_PID_FILE"
    else
        pkill -f "ipmonitor" 2>/dev/null
    fi
}

_check_all_ready() {
    [ -f "$MAGISK_MOD_DIR/disable" ] && { log_warn "Service disabled, ignoring readiness trigger"; return; }
    # Both core_ok and tproxy_ok must exist
    [ -f "$EVENTS_DIR/core_ok" ] && [ -f "$EVENTS_DIR/tproxy_ok" ] && {
            rm -f "$EVENTS_DIR/core_ok" "$EVENTS_DIR/tproxy_ok"
            log_info "All components ready, starting ipmonitor..."
            nohup sh "$MONITOR_SCRIPT" start >/dev/null 2>&1 &
            sync_prop
            log_info "Service ready"
    }
}

_stop_components() {
    log_info "Stopping services..."
    sh "$CORE_SCRIPT" stop &
    sh "$TPROXY_SCRIPT" stop &
    
    _kill_ipmonitor
    
    wait
    rm -f "$EVENTS_DIR/core_ok" "$EVENTS_DIR/tproxy_ok" 2>/dev/null
    sync_prop
    prop_clear
    log_info "Service stopped"
}

_rollback_components() {
    log_warn "Rolling back..."
    sh "$CORE_SCRIPT" stop 2>/dev/null &
    sh "$TPROXY_SCRIPT" stop 2>/dev/null &
    _kill_ipmonitor &
    wait
    sync_prop
}

# ==============================================================================
# [ Event Dispatch ]
# ==============================================================================

case "$EVENT_NAME" in
    # === Magisk module toggle ===
    disable)
        case "$EVENT_TYPE" in
            d) sh "$INIT_SCRIPT" & ;;   # Delete = Enable = Start
            n) _stop_components ;;      # Create = Disable = Stop
        esac
        ;;
    # === Flow markers ===
    init_ok)
        rm -f "$WATCHED_PATH" 2>/dev/null
        _start_components
        ;;
    core_ok)
        _check_all_ready
        ;;
    tproxy_ok)
        _check_all_ready
        ;;
    # === Failure handling ===
    fail)
        _rollback_components
        exit 0
        ;;
    # === IP sync ===
    ip_sync)
        rm -f "$WATCHED_PATH" 2>/dev/null
        sh "$IP_HANDLER_SCRIPT" &
        ;;
    # === Unknown/Cleanup ===
    *)
        rm -f "$WATCHED_PATH" 2>/dev/null
        ;;
esac
